From 26fe7f94d0c4dd84cf5e19eb5a60b6c5fe5371b4 Mon Sep 17 00:00:00 2001
From: Vladimir Barinov <vladimir.barinov@cogentembedded.com>
Date: Thu, 10 Dec 2020 19:14:43 +0300
Subject: [PATCH] media: rcar_csi2: fix race condition

Fix race at STREAMON/OFF

Signed-off-by: Vladimir Barinov <vladimir.barinov@cogentembedded.com>
---
 drivers/media/platform/soc_camera/rcar_csi2.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/drivers/media/platform/soc_camera/rcar_csi2.c b/drivers/media/platform/soc_camera/rcar_csi2.c
index f2c933a..73ef28f 100644
--- a/drivers/media/platform/soc_camera/rcar_csi2.c
+++ b/drivers/media/platform/soc_camera/rcar_csi2.c
@@ -227,7 +227,7 @@ struct rcar_csi2 {
 	unsigned int			code;
 	unsigned int			lanes;
 	unsigned int			csi_rate;
-	spinlock_t			lock;
+	struct mutex			lock;
 	atomic_t			use_count;
 	unsigned int			use_interrupts;
 	u64				timestamp[4];
@@ -678,6 +678,8 @@ static int rcar_csi2_s_power(struct v4l2_subdev *sd, int on)
 	int ret = 0;
 	int idx = sd->grp_id;
 
+	mutex_lock(&priv->lock);
+
 	if (idx < 2) {
 		priv->vcdt &= ~(RCAR_CSI2_VCDT_VCDTN_EN << (idx * 16));
 		priv->vcdt |= (on ? RCAR_CSI2_VCDT_VCDTN_EN << (idx * 16) : 0);
@@ -709,6 +711,8 @@ static int rcar_csi2_s_power(struct v4l2_subdev *sd, int on)
 	dev_dbg(&priv->pdev->dev, "CSI2 VCDT2: 0x%x\n",
 			 ioread32(priv->base + RCAR_CSI2_VCDT2));
 
+	mutex_unlock(&priv->lock);
+
 	return ret;
 }
 
@@ -895,6 +899,7 @@ static int rcar_csi2_probe(struct platform_device *pdev)
 	priv->csi_rate = link_config.csi_rate;
 	priv->use_interrupts = link_config.use_interrupts;
 	atomic_set(&priv->use_count, 0);
+	mutex_init(&priv->lock);
 
 	platform_set_drvdata(pdev, priv);
 
-- 
2.7.4

