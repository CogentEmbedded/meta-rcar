From 5c45ad05581e8f4817fc01d621b0cd7011e82a47 Mon Sep 17 00:00:00 2001
From: Vladimir Barinov <vladimir.barinov@cogentembedded.com>
Date: Sun, 18 Apr 2021 13:33:36 +0300
Subject: [PATCH] media: i2c: soc_camera: ov2311: add more i2c address

This add more OV2311 i2c latch address

Signed-off-by: Vladimir Barinov <vladimir.barinov@cogentembedded.com>
---
 drivers/media/i2c/soc_camera/ov2311.c | 36 +++++++++++++++++++++++++----------
 1 file changed, 26 insertions(+), 10 deletions(-)

diff --git a/drivers/media/i2c/soc_camera/ov2311.c b/drivers/media/i2c/soc_camera/ov2311.c
index ed271ec..1c74518 100644
--- a/drivers/media/i2c/soc_camera/ov2311.c
+++ b/drivers/media/i2c/soc_camera/ov2311.c
@@ -23,7 +23,7 @@
 #include "max9286.h"
 #include "ov2311.h"
 
-#define OV2311_I2C_ADDR			0x60
+static const int ov2311_i2c_addr[] = {0x10, 0x60};
 
 #define OV2311_PID			0x300a
 #define OV2311_VER			0x300b
@@ -406,15 +406,34 @@ static int ov2311_initialize(struct i2c_client *client)
 	u16 pid;
 	u8 val = 0, rev = 0;
 	int ret = 0;
-	int tmp_addr = 0;
+	int tmp_addr = 0, i;
 
 	ov2311_s_port(client, 1);
 
-	/* check and show product ID and manufacturer ID */
-	reg16_read(client, OV2311_PID, &val);
-	pid = val;
-	reg16_read(client, OV2311_VER, &val);
-	pid = (pid << 8) | val;
+	for (i = 0; i < ARRAY_SIZE(ov2311_i2c_addr); i++) {
+		tmp_addr = client->addr;
+		if (priv->max9286_addr) {
+			client->addr = priv->max9271_addr;			/* Serializer I2C address */
+
+			reg8_write(client, 0x0A, ov2311_i2c_addr[i] << 1);	/* Sensor native I2C address */
+			usleep_range(2000, 2500);				/* wait 2ms */
+		};
+		if (priv->ti9x4_addr) {
+			client->addr = priv->ti9x4_addr;
+			reg8_write(client, 0x5d, ov2311_i2c_addr[i] << 1);	/* Sensor native I2C address */
+			usleep_range(2000, 2500);
+		}
+		client->addr = tmp_addr;
+
+		/* check product ID */
+		reg16_read(client, OV2311_PID, &val);
+		pid = val;
+		reg16_read(client, OV2311_VER, &val);
+		pid = (pid << 8) | val;
+
+		if (pid == OV2311_VERSION_REG)
+			break;
+	}
 
 	if (pid != OV2311_VERSION_REG) {
 		dev_dbg(&client->dev, "Product ID error %x\n", pid);
@@ -489,8 +508,6 @@ static int ov2311_parse_dt(struct device_node *np, struct ov2311_priv *priv)
 		client->addr = priv->max9271_addr;			/* Serializer I2C address */
 
 		reg8_write(client, 0x09, tmp_addr << 1);		/* Sensor translated I2C address */
-		reg8_write(client, 0x0A, OV2311_I2C_ADDR << 1);		/* Sensor native I2C address */
-		usleep_range(2000, 2500);				/* wait 2ms */
 	};
 
 	if (priv->ti9x4_addr) {
@@ -499,7 +516,6 @@ static int ov2311_parse_dt(struct device_node *np, struct ov2311_priv *priv)
 		reg8_write(client, 0x4c, (priv->port << 4) | (1 << priv->port)); /* Select RX port number */
 		usleep_range(2000, 2500);				/* wait 2ms */
 		reg8_write(client, 0x65, tmp_addr << 1);		/* Sensor translated I2C address */
-		reg8_write(client, 0x5d, OV2311_I2C_ADDR << 1);		/* Sensor native I2C address */
 	}
 	client->addr = tmp_addr;
 
-- 
2.7.4

