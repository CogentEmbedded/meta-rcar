From 4d6525b0e0d33334c87ea59393fc0829e4a01454 Mon Sep 17 00:00:00 2001
From: Vladimir Barinov <vladimir.barinov@cogentembedded.com>
Date: Mon, 22 Mar 2021 22:00:44 +0300
Subject: [PATCH] media: i2c: ox03a: add more imager address

This supports more possible imager i2c address

Signed-off-by: Vladimir Barinov <vladimir.barinov@cogentembedded.com>
---
 drivers/media/i2c/soc_camera/ox03a.c | 27 ++++++++++++++++++++-------
 1 file changed, 20 insertions(+), 7 deletions(-)

diff --git a/drivers/media/i2c/soc_camera/ox03a.c b/drivers/media/i2c/soc_camera/ox03a.c
index 66087a0..9569c70 100644
--- a/drivers/media/i2c/soc_camera/ox03a.c
+++ b/drivers/media/i2c/soc_camera/ox03a.c
@@ -22,7 +22,7 @@
 
 #include "ox03a.h"
 
-#define OX03A_I2C_ADDR		0x36
+static const int ox03a_i2c_addr[] = {0x10, 0x36};
 
 #define OX03A_PID		0x300A
 #define OX03A_VER		0x300B
@@ -382,12 +382,26 @@ static int ox03a_initialize(struct i2c_client *client)
 	u8 val = 0;
 	u16 pid;
 	int ret = 0;
+	int tmp_addr, i;
+
+	for (i = 0; i < ARRAY_SIZE(ox03a_i2c_addr); i++) {
+		tmp_addr = client->addr;
+		if (priv->ti9x4_addr) {
+			client->addr = priv->ti9x4_addr;
+			reg8_write(client, 0x5d, ox03a_i2c_addr[i] << 1); /* Sensor native I2C address */
+			usleep_range(2000, 2500);
+		}
+		client->addr = tmp_addr;
+
+		/* check product ID */
+		reg16_read(client, OX03A_PID, &val);
+		pid = val;
+		reg16_read(client, OX03A_VER, &val);
+		pid = (pid << 8) | val;
 
-	/* check and show model ID */
-	reg16_read(client, OX03A_PID, &val);
-	pid = val;
-	reg16_read(client, OX03A_VER, &val);
-	pid = (pid << 8) | val;
+		if (pid == OX03A_VERSION_REG)
+			break;
+	}
 
 	if (pid != OX03A_VERSION_REG) {
 		dev_dbg(&client->dev, "Product ID error %x\n", pid);
@@ -443,7 +457,6 @@ static int ox03a_parse_dt(struct device_node *np, struct ox03a_priv *priv)
 		reg8_write(client, 0x4c, (priv->port << 4) | (1 << priv->port)); /* Select RX port number */
 		usleep_range(2000, 2500);				/* wait 2ms */
 		reg8_write(client, 0x65, tmp_addr << 1);		/* Sensor translated I2C address */
-		reg8_write(client, 0x5d, OX03A_I2C_ADDR << 1);		/* Sensor native I2C address */
 //		reg8_write(client, 0x6e, 0xa9);				/* GPIO0 - reset, GPIO1 - fsin */
 
 		client->addr = priv->ti9x3_addr;			/* Serializer I2C address */
-- 
2.7.4

