From 74c70567b3d9d7e3d07b7aed64d953055d7ec262 Mon Sep 17 00:00:00 2001
From: Andrey Dolnikov <andrey.dolnikov@cogentembedded.com>
Date: Fri, 18 Jan 2019 14:28:54 +0300
Subject: [PATCH] media: soc_camera: Add events support

---
 drivers/media/platform/soc_camera/rcar_vin.c       |  2 +-
 .../platform/soc_camera/sh_mobile_ceu_camera.c     |  2 +-
 drivers/media/platform/soc_camera/soc_camera.c     | 88 ++++++++++++++--------
 include/media/soc_camera.h                         |  4 +
 4 files changed, 64 insertions(+), 32 deletions(-)

diff --git a/drivers/media/platform/soc_camera/rcar_vin.c b/drivers/media/platform/soc_camera/rcar_vin.c
index f8f5a16..7845681 100644
--- a/drivers/media/platform/soc_camera/rcar_vin.c
+++ b/drivers/media/platform/soc_camera/rcar_vin.c
@@ -2628,7 +2628,7 @@ static int rcar_vin_try_fmt(struct soc_camera_device *icd,
 
 static unsigned int rcar_vin_poll(struct file *file, poll_table *pt)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 
 	return vb2_poll(&icd->vb2_vidq, file, pt);
 }
diff --git a/drivers/media/platform/soc_camera/sh_mobile_ceu_camera.c b/drivers/media/platform/soc_camera/sh_mobile_ceu_camera.c
index a15bfb5..7a12468 100644
--- a/drivers/media/platform/soc_camera/sh_mobile_ceu_camera.c
+++ b/drivers/media/platform/soc_camera/sh_mobile_ceu_camera.c
@@ -1555,7 +1555,7 @@ static int sh_mobile_ceu_set_liveselection(struct soc_camera_device *icd,
 
 static unsigned int sh_mobile_ceu_poll(struct file *file, poll_table *pt)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 
 	return vb2_poll(&icd->vb2_vidq, file, pt);
 }
diff --git a/drivers/media/platform/soc_camera/soc_camera.c b/drivers/media/platform/soc_camera/soc_camera.c
index 1d0142e..2f81702 100644
--- a/drivers/media/platform/soc_camera/soc_camera.c
+++ b/drivers/media/platform/soc_camera/soc_camera.c
@@ -294,7 +294,7 @@ static int soc_camera_try_fmt(struct soc_camera_device *icd,
 static int soc_camera_try_fmt_vid_cap(struct file *file, void *priv,
 				      struct v4l2_format *f)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 
 	WARN_ON(priv != file->private_data);
 
@@ -309,7 +309,7 @@ static int soc_camera_try_fmt_vid_cap(struct file *file, void *priv,
 static int soc_camera_enum_input(struct file *file, void *priv,
 				 struct v4l2_input *inp)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 
 	if (inp->index != 0)
 		return -EINVAL;
@@ -339,7 +339,7 @@ static int soc_camera_s_input(struct file *file, void *priv, unsigned int i)
 
 static int soc_camera_s_std(struct file *file, void *priv, v4l2_std_id a)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct v4l2_subdev *sd = soc_camera_to_subdev(icd);
 
 	return v4l2_subdev_call(sd, video, s_std, a);
@@ -347,7 +347,7 @@ static int soc_camera_s_std(struct file *file, void *priv, v4l2_std_id a)
 
 static int soc_camera_g_std(struct file *file, void *priv, v4l2_std_id *a)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct v4l2_subdev *sd = soc_camera_to_subdev(icd);
 
 	return v4l2_subdev_call(sd, video, g_std, a);
@@ -356,7 +356,7 @@ static int soc_camera_g_std(struct file *file, void *priv, v4l2_std_id *a)
 static int soc_camera_enum_framesizes(struct file *file, void *fh,
 					 struct v4l2_frmsizeenum *fsize)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	return ici->ops->enum_framesizes(icd, fsize);
@@ -366,7 +366,7 @@ static int soc_camera_reqbufs(struct file *file, void *priv,
 			      struct v4l2_requestbuffers *p)
 {
 	int ret;
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	WARN_ON(priv != file->private_data);
@@ -392,7 +392,7 @@ static int soc_camera_reqbufs(struct file *file, void *priv,
 static int soc_camera_querybuf(struct file *file, void *priv,
 			       struct v4l2_buffer *p)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	WARN_ON(priv != file->private_data);
@@ -406,7 +406,7 @@ static int soc_camera_querybuf(struct file *file, void *priv,
 static int soc_camera_qbuf(struct file *file, void *priv,
 			   struct v4l2_buffer *p)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	WARN_ON(priv != file->private_data);
@@ -423,7 +423,7 @@ static int soc_camera_qbuf(struct file *file, void *priv,
 static int soc_camera_dqbuf(struct file *file, void *priv,
 			    struct v4l2_buffer *p)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	WARN_ON(priv != file->private_data);
@@ -440,7 +440,7 @@ static int soc_camera_dqbuf(struct file *file, void *priv,
 static int soc_camera_create_bufs(struct file *file, void *priv,
 			    struct v4l2_create_buffers *create)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 	int ret;
 
@@ -460,7 +460,7 @@ static int soc_camera_create_bufs(struct file *file, void *priv,
 static int soc_camera_prepare_buf(struct file *file, void *priv,
 				  struct v4l2_buffer *b)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	/* videobuf2 only */
@@ -473,7 +473,7 @@ static int soc_camera_prepare_buf(struct file *file, void *priv,
 static int soc_camera_expbuf(struct file *file, void *priv,
 			     struct v4l2_exportbuffer *p)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	/* videobuf2 only */
@@ -676,6 +676,7 @@ static int soc_camera_open(struct file *file)
 		return -ENODEV;
 	}
 
+	v4l2_fh_open(file);
 	icd = video_get_drvdata(vdev);
 	ici = to_soc_camera_host(icd->parent);
 
@@ -756,7 +757,6 @@ static int soc_camera_open(struct file *file)
 	}
 	mutex_unlock(&ici->host_lock);
 
-	file->private_data = icd;
 	dev_dbg(icd->pdev, "camera device open\n");
 
 	return 0;
@@ -784,14 +784,19 @@ static int soc_camera_open(struct file *file)
 
 static int soc_camera_close(struct file *file)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
+	struct v4l2_event ev;
 
 	mutex_lock(&ici->host_lock);
 	if (icd->streamer == file) {
 		if (ici->ops->init_videobuf2)
 			vb2_queue_release(&icd->vb2_vidq);
 		icd->streamer = NULL;
+
+		memset(&ev, 0, sizeof(ev));
+		ev.type = V4L2_EVENT_EOS;
+		v4l2_event_queue(icd->vdev, &ev);
 	}
 	icd->use_count--;
 	if (!icd->use_count) {
@@ -803,6 +808,8 @@ static int soc_camera_close(struct file *file)
 		soc_camera_remove_device(icd);
 	}
 
+	v4l2_fh_release(file);
+
 	mutex_unlock(&ici->host_lock);
 
 	module_put(ici->ops->owner);
@@ -815,7 +822,7 @@ static int soc_camera_close(struct file *file)
 static ssize_t soc_camera_read(struct file *file, char __user *buf,
 			       size_t count, loff_t *ppos)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	dev_dbg(icd->pdev, "read called, buf %p\n", buf);
@@ -831,7 +838,7 @@ static ssize_t soc_camera_read(struct file *file, char __user *buf,
 
 static int soc_camera_mmap(struct file *file, struct vm_area_struct *vma)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 	int err;
 
@@ -858,12 +865,14 @@ static int soc_camera_mmap(struct file *file, struct vm_area_struct *vma)
 
 static unsigned int soc_camera_poll(struct file *file, poll_table *pt)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 	unsigned res = POLLERR;
 
+/*
 	if (icd->streamer != file)
 		return POLLERR;
+*/
 
 	mutex_lock(&ici->host_lock);
 	if (ici->ops->init_videobuf && list_empty(&icd->vb_vidq.stream))
@@ -887,7 +896,7 @@ static struct v4l2_file_operations soc_camera_fops = {
 static int soc_camera_s_fmt_vid_cap(struct file *file, void *priv,
 				    struct v4l2_format *f)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	int ret;
 
 	WARN_ON(priv != file->private_data);
@@ -916,7 +925,7 @@ static int soc_camera_s_fmt_vid_cap(struct file *file, void *priv,
 static int soc_camera_enum_fmt_vid_cap(struct file *file, void  *priv,
 				       struct v4l2_fmtdesc *f)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	const struct soc_mbus_pixelfmt *format;
 
 	WARN_ON(priv != file->private_data);
@@ -935,7 +944,7 @@ static int soc_camera_enum_fmt_vid_cap(struct file *file, void  *priv,
 static int soc_camera_g_fmt_vid_cap(struct file *file, void *priv,
 				    struct v4l2_format *f)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct v4l2_pix_format *pix = &f->fmt.pix;
 
 	WARN_ON(priv != file->private_data);
@@ -958,7 +967,7 @@ static int soc_camera_g_fmt_vid_cap(struct file *file, void *priv,
 static int soc_camera_querycap(struct file *file, void  *priv,
 			       struct v4l2_capability *cap)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	WARN_ON(priv != file->private_data);
@@ -970,9 +979,10 @@ static int soc_camera_querycap(struct file *file, void  *priv,
 static int soc_camera_streamon(struct file *file, void *priv,
 			       enum v4l2_buf_type i)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 	struct v4l2_subdev *sd = soc_camera_to_subdev(icd);
+	struct v4l2_event ev;
 	int ret;
 
 	WARN_ON(priv != file->private_data);
@@ -992,15 +1002,20 @@ static int soc_camera_streamon(struct file *file, void *priv,
 	if (!ret)
 		v4l2_subdev_call(sd, video, s_stream, 1);
 
+	memset(&ev, 0, sizeof(ev));
+	ev.type = V4L2_EVENT_SOC_START_STREAM;
+	v4l2_event_queue(icd->vdev, &ev);
+
 	return ret;
 }
 
 static int soc_camera_streamoff(struct file *file, void *priv,
 				enum v4l2_buf_type i)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct v4l2_subdev *sd = soc_camera_to_subdev(icd);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
+	struct v4l2_event ev;
 	int ret;
 
 	WARN_ON(priv != file->private_data);
@@ -1022,13 +1037,17 @@ static int soc_camera_streamoff(struct file *file, void *priv,
 
 	v4l2_subdev_call(sd, video, s_stream, 0);
 
+	memset(&ev, 0, sizeof(ev));
+	ev.type = V4L2_EVENT_EOS;
+	v4l2_event_queue(icd->vdev, &ev);
+
 	return ret;
 }
 
 static int soc_camera_g_selection(struct file *file, void *fh,
 				  struct v4l2_selection *s)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	/* With a wrong type no need to try to fall back to cropping */
@@ -1041,7 +1060,7 @@ static int soc_camera_g_selection(struct file *file, void *fh,
 static int soc_camera_s_selection(struct file *file, void *fh,
 				  struct v4l2_selection *s)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 	int ret;
 
@@ -1085,7 +1104,7 @@ static int soc_camera_s_selection(struct file *file, void *fh,
 static int soc_camera_g_parm(struct file *file, void *fh,
 			     struct v4l2_streamparm *a)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	if (ici->ops->get_parm)
@@ -1097,7 +1116,7 @@ static int soc_camera_g_parm(struct file *file, void *fh,
 static int soc_camera_s_parm(struct file *file, void *fh,
 			     struct v4l2_streamparm *a)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	if (ici->ops->set_parm)
@@ -1109,7 +1128,7 @@ static int soc_camera_s_parm(struct file *file, void *fh,
 static int soc_camera_g_edid(struct file *file, void *fh,
 			     struct v4l2_edid *edid)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	if (ici->ops->get_edid)
@@ -1122,7 +1141,7 @@ static int soc_camera_g_edid(struct file *file, void *fh,
 static int soc_camera_g_register(struct file *file, void *priv,
 				 struct v4l2_dbg_register *reg)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	if (ici->ops->get_register)
@@ -1134,7 +1153,7 @@ static int soc_camera_g_register(struct file *file, void *priv,
 static int soc_camera_s_register(struct file *file, void *priv,
 				 const struct v4l2_dbg_register *reg)
 {
-	struct soc_camera_device *icd = file->private_data;
+	struct soc_camera_device *icd = video_drvdata(file);
 	struct soc_camera_host *ici = to_soc_camera_host(icd->parent);
 
 	if (ici->ops->set_register)
@@ -2104,6 +2123,13 @@ static int soc_camera_device_register(struct soc_camera_device *icd)
 	return 0;
 }
 
+static int soc_camera_subscribe_event(struct v4l2_fh *fh,
+                         const struct v4l2_event_subscription *sub)
+{
+	/* Just subscribe any event */
+	return v4l2_event_subscribe(fh, sub, 16, NULL);
+}
+
 static const struct v4l2_ioctl_ops soc_camera_ioctl_ops = {
 	.vidioc_querycap	 = soc_camera_querycap,
 	.vidioc_try_fmt_vid_cap  = soc_camera_try_fmt_vid_cap,
@@ -2134,6 +2160,8 @@ static const struct v4l2_ioctl_ops soc_camera_ioctl_ops = {
 	.vidioc_g_register	= soc_camera_g_register,
 	.vidioc_s_register	= soc_camera_s_register,
 #endif
+	.vidioc_subscribe_event	= soc_camera_subscribe_event,
+	.vidioc_unsubscribe_event = v4l2_event_unsubscribe,
 };
 
 static int video_dev_create(struct soc_camera_device *icd)
diff --git a/include/media/soc_camera.h b/include/media/soc_camera.h
index de00751..acfa38a 100644
--- a/include/media/soc_camera.h
+++ b/include/media/soc_camera.h
@@ -22,6 +22,10 @@
 #include <media/v4l2-async.h>
 #include <media/v4l2-ctrls.h>
 #include <media/v4l2-device.h>
+#include <media/v4l2-event.h>
+
+#define V4L2_EVENT_SOC_START_STREAM	(V4L2_EVENT_PRIVATE_START + 1)
+#define V4L2_EVENT_SOC_PRIVATE_START	(V4L2_EVENT_PRIVATE_START + 1)
 
 struct file;
 struct soc_camera_desc;
-- 
2.7.4

