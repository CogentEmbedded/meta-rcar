From d4f06065628152f5d5e23ce7039f83b83a6011af Mon Sep 17 00:00:00 2001
From: Vladimir Barinov <vladimir.barinov@cogentembedded.com>
Date: Mon, 18 Sep 2017 08:32:53 +0300
Subject: [PATCH] AR0132: reoder CSI2 MIPI RAW12 into 2BPP format

Rorder 1.5BPP RAW12 to 2BPP format

Signed-off-by: Vladimir Barinov <vladimir.barinov@cogentembedded.com>
---
 drivers/media/i2c/soc_camera/ar0132.h        |  6 ++--
 drivers/media/platform/soc_camera/rcar_vin.c | 49 ++++++++++++++++++++++++++++
 2 files changed, 52 insertions(+), 3 deletions(-)

diff --git a/drivers/media/i2c/soc_camera/ar0132.h b/drivers/media/i2c/soc_camera/ar0132.h
index 055841d..7ae20aa 100644
--- a/drivers/media/i2c/soc_camera/ar0132.h
+++ b/drivers/media/i2c/soc_camera/ar0132.h
@@ -14,7 +14,7 @@
 
 #define AR0132_EMBEDDED_LINE
 
-#define AR0132_MAX_WIDTH		1104
+#define AR0132_MAX_WIDTH		2208
 #define AR0132_MAX_HEIGHT		624
 
 #define AR0132_DELAY			0xffff
diff --git a/drivers/media/platform/soc_camera/rcar_vin.c b/drivers/media/platform/soc_camera/rcar_vin.c
index 9ab6f00..70358e2 100644
--- a/drivers/media/platform/soc_camera/rcar_vin.c
+++ b/drivers/media/platform/soc_camera/rcar_vin.c
@@ -1303,6 +1303,52 @@ static irqreturn_t rcar_vin_threaded_irq(int irq, void *data)
 	return IRQ_HANDLED;
 };
 
+static void rcar_vin_reorder(void *buf_offset)
+{
+	u32 *src = (u32 *)(buf_offset + 2208 * 624 - 552) - 1;
+	u32 *dst = (u32 *)(buf_offset + 2208 * 624 ) - 1;
+	u32 val, i, j;
+
+	for (j = 0; j < 624; j++) {
+		for (i = 0; i < 138 /*=2208/16*/; i++) {
+			val = (*src >> 8) & 0x00ffffff;
+			*dst =  ((val << 12) & 0x0ff00000) | // 012    0xXX361245 -> 0x01230456
+				((val >>  4) & 0x000f0000) | // 3
+				((val <<  4) & 0x00000ff0) | // 045
+				((val >> 16) & 0x0000000f);  // 6
+			dst--;
+
+			val = (*src << 16) & 0x00ff0000;
+			src--;
+			val |= (*src >> 16) & 0x0000ffff;
+			*dst =  ((val << 12) & 0x0ff00000) | // 012    0xXX361245 -> 0x01230456
+				((val >>  4) & 0x000f0000) | // 3
+				((val <<  4) & 0x00000ff0) | // 045
+				((val >> 16) & 0x0000000f);  // 6
+			dst--;
+
+			val = (*src << 8) & 0x00ffff00;
+			src--;
+			val |= (*src >> 24) & 0x000000ff;
+			*dst =  ((val << 12) & 0x0ff00000) | // 012    0xXX361245 -> 0x01230456
+				((val >>  4) & 0x000f0000) | // 3
+				((val <<  4) & 0x00000ff0) | // 045
+				((val >> 16) & 0x0000000f);  // 6
+			dst--;
+
+			val = *src;
+			src--;
+			*dst =  ((val << 12) & 0x0ff00000) | // 012    0xXX361245 -> 0x01230456
+				((val >>  4) & 0x000f0000) | // 3
+				((val <<  4) & 0x00000ff0) | // 045
+				((val >> 16) & 0x0000000f);  // 6
+			dst--;
+		}
+
+		src -= 138; /*552 bytes*/
+	}
+}
+
 static irqreturn_t rcar_vin_irq(int irq, void *data)
 {
 	struct rcar_vin_priv *priv = data;
@@ -1348,6 +1394,9 @@ static irqreturn_t rcar_vin_irq(int irq, void *data)
 			priv->queue_buf[slot]->sequence = priv->sequence++;
 			priv->queue_buf[slot]->vb2_buf.timestamp =
 							 ktime_get_ns();
+#if 1
+			rcar_vin_reorder(vb2_plane_vaddr(&priv->queue_buf[slot]->vb2_buf, 0));
+#endif
 			vb2_buffer_done(&priv->queue_buf[slot]->vb2_buf,
 							VB2_BUF_STATE_DONE);
 			priv->queue_buf[slot] = NULL;
-- 
1.9.1

