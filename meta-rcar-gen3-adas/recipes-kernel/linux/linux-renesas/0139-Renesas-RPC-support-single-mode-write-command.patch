From 01234cf376a9feefdf1ea7728765caf74fcf5a7d Mon Sep 17 00:00:00 2001
From: Andrey Gusakov <andrey.gusakov@cogentembedded.com>
Date: Wed, 18 Jul 2018 13:07:15 +0300
Subject: [PATCH 2/3] Renesas: RPC: support single mode write command

---
 drivers/mtd/spi-nor/renesas-rpc.c | 12 ++++++++----
 1 file changed, 8 insertions(+), 4 deletions(-)

diff --git a/drivers/mtd/spi-nor/renesas-rpc.c b/drivers/mtd/spi-nor/renesas-rpc.c
index 00c0050..c493c7c 100644
--- a/drivers/mtd/spi-nor/renesas-rpc.c
+++ b/drivers/mtd/spi-nor/renesas-rpc.c
@@ -548,7 +548,7 @@ static void rpc_setup_write_mode_command_and_adr(struct rpc_spi *rpc,
 	rpc_write(rpc, SMENR, val);
 }
 
-static int rpc_setup_write_mode(struct rpc_spi *rpc)
+static int rpc_setup_write_mode(struct rpc_spi *rpc, u8 opcode)
 {
 	u32 val;
 
@@ -569,7 +569,11 @@ static int rpc_setup_write_mode(struct rpc_spi *rpc)
 	val = rpc_read(rpc, SMENR);
 	val &= ~(SMENR_OCDB_MASK | SMENR_DME | SMENR_OCDE | SMENR_SPIDB_MASK
 		 | SMENR_ADB_MASK | SMENR_OPDE_MASK | SMENR_SPIDE_MASK);
-	val |= SMENR_SPIDE_32B;
+	if (opcode != SPINOR_OP_PP)
+		val |= SMENR_SPIDE_32B;
+	else
+		val |= SMENR_SPIDE_8B;
+
 	rpc_write(rpc, SMENR, val);
 
 	return 0;
@@ -744,7 +748,7 @@ static ssize_t rpc_write_flash(struct spi_nor *nor, loff_t to, size_t len,
 	bo = to & (WRITE_BUF_ADR_MASK);
 
 	rpc_flush_cache(rpc);
-	rpc_setup_write_mode(rpc);
+	rpc_setup_write_mode(rpc, nor->program_opcode);
 	rpc_setup_write_mode_command_and_adr(rpc, nor->addr_width, true);
 	rpc_setup_writemode_nbits(rpc, 1, 1, 1);
 
@@ -761,7 +765,7 @@ static ssize_t rpc_write_flash(struct spi_nor *nor, loff_t to, size_t len,
 		size_t min = (len < (WRITE_BUF_SIZE - bo)) ? len : (WRITE_BUF_SIZE - bo);
 
 		rpc_write_unaligned(nor, to, min, buf, full);
-		rpc_setup_write_mode(rpc);
+		rpc_setup_write_mode(rpc, nor->program_opcode);
 
 		len -= min;
 		buf += min;
-- 
1.9.1

