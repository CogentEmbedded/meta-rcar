From 9362bb2c813aab4b8b648b71e1e6bf5aede9b64c Mon Sep 17 00:00:00 2001
From: Nicolas Dufresne <nicolas.dufresne@collabora.com>
Date: Wed, 9 Aug 2017 14:55:44 -0400
Subject: [PATCH 53/80] kmssink: Add bus-id property

https://bugzilla.gnome.org/show_bug.cgi?id=786112
---
 sys/kms/gstkmssink.c | 24 ++++++++++++++++++++++--
 sys/kms/gstkmssink.h |  1 +
 2 files changed, 23 insertions(+), 2 deletions(-)

diff --git a/sys/kms/gstkmssink.c b/sys/kms/gstkmssink.c
index a7789e2e0..d37762a0d 100644
--- a/sys/kms/gstkmssink.c
+++ b/sys/kms/gstkmssink.c
@@ -75,6 +75,7 @@ static void gst_kms_sink_drain (GstKMSSink * self);
 enum
 {
   PROP_DRIVER_NAME = 1,
+  PROP_BUS_ID,
   PROP_CONNECTOR_ID,
   PROP_PLANE_ID,
   PROP_FORCE_MODESETTING,
@@ -561,8 +562,8 @@ gst_kms_sink_start (GstBaseSink * bsink)
   pres = NULL;
   plane = NULL;
 
-  if (self->devname)
-    self->fd = drmOpen (self->devname, NULL);
+  if (self->devname || self->bus_id)
+    self->fd = drmOpen (self->devname, self->bus_id);
   else
     self->fd = kms_open (&self->devname);
   if (self->fd < 0)
@@ -1436,6 +1437,10 @@ gst_kms_sink_set_property (GObject * object, guint prop_id,
       g_free (sink->devname);
       sink->devname = g_value_dup_string (value);
       break;
+    case PROP_BUS_ID:
+      g_free (sink->bus_id);
+      sink->bus_id = g_value_dup_string (value);
+      break;
     case PROP_CONNECTOR_ID:
       sink->conn_id = g_value_get_int (value);
       break;
@@ -1463,6 +1468,9 @@ gst_kms_sink_get_property (GObject * object, guint prop_id,
     case PROP_DRIVER_NAME:
       g_value_take_string (value, sink->devname);
       break;
+    case PROP_BUS_ID:
+      g_value_take_string (value, sink->bus_id);
+      break;
     case PROP_CONNECTOR_ID:
       g_value_set_int (value, sink->conn_id);
       break;
@@ -1485,6 +1493,7 @@ gst_kms_sink_finalize (GObject * object)
 
   sink = GST_KMS_SINK (object);
   g_clear_pointer (&sink->devname, g_free);
+  g_clear_pointer (&sink->bus_id, g_free);
   gst_poll_free (sink->poll);
 
   G_OBJECT_CLASS (parent_class)->finalize (object);
@@ -1548,6 +1557,17 @@ gst_kms_sink_class_init (GstKMSSinkClass * klass)
       G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS | G_PARAM_CONSTRUCT);
 
   /**
+   * kmssink:bus-id:
+   *
+   * If you have a system with multiple displays for the same driver-name,
+   * you can choose which display to use by setting the DRM bus ID. Otherwise,
+   * the driver decides which one.
+   */
+  g_properties[PROP_BUS_ID] = g_param_spec_string ("bus-id",
+      "Bus ID", "DRM bus ID", NULL,
+      G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS | G_PARAM_CONSTRUCT);
+
+  /**
    * kmssink:connector-id:
    *
    * A GPU has several output connectors, for example: LVDS, VGA,
diff --git a/sys/kms/gstkmssink.h b/sys/kms/gstkmssink.h
index 8e174b96c..6f0304a91 100644
--- a/sys/kms/gstkmssink.h
+++ b/sys/kms/gstkmssink.h
@@ -74,6 +74,7 @@ struct _GstKMSSink {
   GList *mem_cache;
 
   gchar *devname;
+  gchar *bus_id;
 
   guint32 mm_width, mm_height;
 
-- 
2.11.0

