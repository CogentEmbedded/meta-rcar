From 4c5778401df00652142d4ea8807f3f6416680114 Mon Sep 17 00:00:00 2001
From: Valentine Barshak <valentine.barshak@cogentembedded.com>
Date: Sun, 14 Feb 2021 03:30:49 +0300
Subject: [PATCH 10/18] plat: renesas: Add ICUMXA support

This adds a simple check and waits until ICUMXA completes.

Signed-off-by: Valentine Barshak <valentine.barshak@cogentembedded.com>
---
 plat/renesas/rcar/bl2_plat_setup.c   | 15 +++++++++++++++
 plat/renesas/rcar/include/rcar_def.h |  1 +
 2 files changed, 16 insertions(+)

diff --git a/plat/renesas/rcar/bl2_plat_setup.c b/plat/renesas/rcar/bl2_plat_setup.c
index ca864f9..bf2a7d5 100644
--- a/plat/renesas/rcar/bl2_plat_setup.c
+++ b/plat/renesas/rcar/bl2_plat_setup.c
@@ -717,6 +717,17 @@ static void bl2_advertise_dram_size(uint32_t product)
 	bl2_advertise_dram_entries(dram_config);
 }
 
+static void rcar_icumxa_wait()
+{
+#if (RCAR_LSI == RCAR_V3U)
+	/*
+	 * Wait for the ICUMXA to complete using RTDMA, otherwise
+	 * there might be I/O race with the RPC flash access.
+	 */
+	while (mmio_read_32(0xffc100b0) & 0x1);
+#endif
+}
+
 void bl2_el3_early_platform_setup(u_register_t arg1, u_register_t arg2,
 				  u_register_t arg3, u_register_t arg4)
 {
@@ -771,6 +782,10 @@ void bl2_el3_early_platform_setup(u_register_t arg1, u_register_t arg2,
 		rcar_console_boot_init();
 	}
 
+	if (boot_cpu == MODEMR_BOOT_ICUMXA) {
+		rcar_icumxa_wait();
+	}
+
 	plat_rcar_gic_driver_init();
 	plat_rcar_gic_init();
 	rcar_swdt_init();
diff --git a/plat/renesas/rcar/include/rcar_def.h b/plat/renesas/rcar/include/rcar_def.h
index 6f5343c..1301e2c 100644
--- a/plat/renesas/rcar/include/rcar_def.h
+++ b/plat/renesas/rcar/include/rcar_def.h
@@ -185,6 +185,7 @@
 #define MODEMR_BOOT_CPU_CR7		U(0x000000C0)
 #define MODEMR_BOOT_CPU_CA57		U(0x00000000)
 #define MODEMR_BOOT_CPU_CA53		U(0x00000040)
+#define MODEMR_BOOT_ICUMXA		U(0x00000080)
 #define MODEMR_BOOT_DEV_MASK		U(0x0000001E)
 #define MODEMR_BOOT_DEV_HYPERFLASH160	U(0x00000004)
 #define MODEMR_BOOT_DEV_HYPERFLASH80	U(0x00000006)
-- 
2.7.4

